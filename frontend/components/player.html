<!--
íŒŒì¼ëª…: frontend/components/player.html
ì„¤ëª…: Spotify Web Playback SDKë¥¼ ì‚¬ìš©í•œ í”Œë ˆì´ì–´ HTML ì»´í¬ë„ŒíŠ¸. ì¬ìƒ ì œì–´ ë° íŠ¸ë™ ì •ë³´ í‘œì‹œ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.
ì‘ì„±ì¼: 2025-11-24
ì‘ì„±ì: Antigravity (AI Assistant)
-->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Player</title>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1DB954 0%, #191414 100%);
            color: white;
            padding: 20px;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            box-sizing: border-box;
        }
        .player-container {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 30px;
            width: 100%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .album-art {
            width: 200px;
            height: 200px;
            border-radius: 10px;
            margin: 0 auto 20px;
            background-color: #333;
            background-size: cover;
            background-position: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .track-info {
            margin-bottom: 20px;
        }
        .track-name {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .track-artist {
            font-size: 1em;
            color: #b3b3b3;
        }
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }
        button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.5em;
            transition: transform 0.1s;
        }
        button:hover {
            transform: scale(1.1);
            color: #1DB954;
        }
        .play-btn {
            font-size: 2.5em;
            background: #1DB954;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: black;
        }
        .play-btn:hover {
            background: #1ed760;
            color: black;
        }
        .volume-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        input[type=range] {
            width: 100px;
            accent-color: #1DB954;
        }
        .status {
            margin-top: 15px;
            font-size: 0.8em;
            color: #b3b3b3;
        }
    </style>
</head>
<body>
    <div class="player-container">
        <div class="album-art" id="album-art" style="background-image: url('https://via.placeholder.com/200x200?text=No+Image');"></div>
        
        <div class="track-info">
            <div class="track-name" id="track-name">ì¬ìƒí•  ê³¡ì„ ì„ íƒí•˜ì„¸ìš”</div>
            <div class="track-artist" id="track-artist">-</div>
        </div>
        
        <div class="controls">
            <button onclick="player.previousTrack()">â®ï¸</button>
            <button class="play-btn" onclick="togglePlay()" id="play-btn">â–¶</button>
            <button onclick="player.nextTrack()">â­ï¸</button>
        </div>

        <div class="volume-container">
            <span>ğŸ”ˆ</span>
            <input type="range" min="0" max="100" value="50" id="volume-slider" oninput="setVolume(this.value)">
            <span>ğŸ”Š</span>
        </div>
        
        <div class="status" id="status">Spotify ì—°ê²° ì¤‘...</div>
    </div>

    <script>
        const ACCESS_TOKEN = "{{ACCESS_TOKEN}}";
        const INITIAL_TRACK_URI = "{{INITIAL_TRACK_URI}}";
        const USER_ID = "{{USER_ID}}";
        const API_URL = "{{API_URL}}";
        
        let player;
        let deviceId;
        let isPlaying = false;
        let currentTrack = null;
        let playbackStartTime = null;

        window.onSpotifyWebPlaybackSDKReady = () => {
            player = new Spotify.Player({
                name: 'Streamlit Web Player',
                getOAuthToken: cb => { cb(ACCESS_TOKEN); },
                volume: 0.5
            });

            player.addListener('ready', ({ device_id }) => {
                console.log('Ready with Device ID', device_id);
                deviceId = device_id;
                document.getElementById('status').textContent = 'âœ… ì—°ê²°ë¨';
                
                if (INITIAL_TRACK_URI) {
                    playTrack(INITIAL_TRACK_URI);
                }
            });

            player.addListener('not_ready', ({ device_id }) => {
                console.log('Device ID has gone offline', device_id);
                document.getElementById('status').textContent = 'âŒ ì—°ê²° ëŠê¹€';
            });

            player.addListener('player_state_changed', state => {
                if (!state) return;
                
                const track = state.track_window.current_track;
                const wasPlaying = isPlaying;
                isPlaying = !state.paused;
                
                // ìƒˆë¡œìš´ íŠ¸ë™ì´ ì‹œì‘ë˜ê±°ë‚˜ ì¬ìƒì´ ì‹œì‘ë  ë•Œ ë¡œê·¸ ê¸°ë¡
                if (track && track.uri) {
                    const isNewTrack = !currentTrack || currentTrack.uri !== track.uri;
                    const isPlaybackStarted = !wasPlaying && isPlaying;
                    
                    if (isNewTrack && isPlaying) {
                        // ìƒˆë¡œìš´ íŠ¸ë™ ì¬ìƒ ì‹œì‘
                        currentTrack = {
                            uri: track.uri,
                            name: track.name,
                            artist: track.artists.map(a => a.name).join(', '),
                            genre: null // ì¥ë¥´ëŠ” Spotify APIì—ì„œ ë³„ë„ë¡œ ê°€ì ¸ì™€ì•¼ í•¨
                        };
                        playbackStartTime = Date.now();
                        logPlayback(currentTrack);
                    } else if (isPlaybackStarted && currentTrack) {
                        // ì¼ì‹œì •ì§€ í›„ ì¬ê°œ
                        playbackStartTime = Date.now();
                    } else if (!isPlaying && wasPlaying && currentTrack && playbackStartTime) {
                        // ì¬ìƒ ì¤‘ì§€ - ì¬ìƒ ì‹œê°„ ê³„ì‚°
                        const playbackDuration = Math.floor((Date.now() - playbackStartTime) / 1000);
                        if (playbackDuration > 0) {
                            updatePlaybackDuration(currentTrack.uri, playbackDuration);
                        }
                        playbackStartTime = null;
                    }
                }
                
                document.getElementById('track-name').textContent = track.name;
                document.getElementById('track-artist').textContent = track.artists.map(a => a.name).join(', ');
                
                // ì•¨ë²” ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
                const images = track.album.images;
                if (images && images.length > 0) {
                    // ê°€ì¥ í° ì´ë¯¸ì§€ ì‚¬ìš© (ë³´í†µ ì²« ë²ˆì§¸)
                    document.getElementById('album-art').style.backgroundImage = `url('${images[0].url}')`;
                }
                
                document.getElementById('play-btn').textContent = isPlaying ? 'â¸' : 'â–¶';
            });

            player.connect();
        };

        function togglePlay() {
            player.togglePlay();
        }

        function setVolume(val) {
            player.setVolume(val / 100);
        }

        function playTrack(uri) {
            fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                method: 'PUT',
                body: JSON.stringify({ uris: [uri] }),
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${ACCESS_TOKEN}`
                },
            });
        }
        
        function logPlayback(track) {
            if (!USER_ID || !API_URL) return;
            
            fetch(`${API_URL}/music/playback`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user_id: parseInt(USER_ID),
                    track_uri: track.uri,
                    track_name: track.name,
                    artist_name: track.artist,
                    genre: track.genre,
                    playback_duration: 0
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.completed_achievements && data.completed_achievements.length > 0) {
                    // ë„ì „ê³¼ì œ ë‹¬ì„± ì•Œë¦¼
                    data.completed_achievements.forEach(achievement => {
                        console.log(`ë„ì „ê³¼ì œ ë‹¬ì„±: ${achievement.title}`);
                        // ë¶€ëª¨ ì°½ì— ì•Œë¦¼ ì „ì†¡ (Streamlitì—ì„œ ì²˜ë¦¬)
                        if (window.parent) {
                            window.parent.postMessage({
                                type: 'ACHIEVEMENT_COMPLETED',
                                achievement: achievement
                            }, '*');
                        }
                    });
                }
            })
            .catch(error => {
                console.error('ì¬ìƒ ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨:', error);
            });
        }
        
        function updatePlaybackDuration(trackUri, duration) {
            // ì¬ìƒ ì‹œê°„ ì—…ë°ì´íŠ¸ëŠ” ì„ íƒì  (í˜„ì¬ëŠ” ê¸°ë¡ë§Œ)
            console.log(`ì¬ìƒ ì‹œê°„: ${trackUri} - ${duration}ì´ˆ`);
        }
    </script>
</body>
</html>
